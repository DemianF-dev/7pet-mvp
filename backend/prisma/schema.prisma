generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["relationJoins"]
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model User {
  id                      String                       @id @default(uuid())
  email                   String                       @unique
  passwordHash            String?
  googleId                String?                      @unique
  name                    String?
  phone                   String?
  document                String?
  address                 String?
  birthday                DateTime?
  admissionDate           DateTime?
  notes                   String?
  permissions             String?
  createdAt               DateTime                     @default(now())
  updatedAt               DateTime                     @updatedAt
  deletedAt               DateTime?
  extraAddresses          Json?                        @default("[]")
  extraEmails             Json?                        @default("[]")
  extraPhones             Json?                        @default("[]")
  firstName               String?
  lastName                String?
  seqId                   Int                          @unique @default(autoincrement())
  staffId                 Int?                         @unique
  showTutorial            Boolean                      @default(true)
  color                   String?                      @default("#3B82F6")
  role                    String?
  plainPassword           String?
  division                String                       @default("CLIENTE")
  isEligible              Boolean                      @default(false)
  active                  Boolean                      @default(true)
  isSupportAgent          Boolean                      @default(false)
  assignedAppointments    Appointment[]                @relation("AppointmentPerformer")
  authenticators          Authenticator[]
  bugReports              BugReport[]
  comments                Comment[]
  customer                Customer?
  sentMessages            Message[]                    @relation("MessageSender")
  notifications           Notification[]
  conversations           Participant[]
  posts                   Post[]
  pushSubscriptions       PushSubscription[]
  performedItems          QuoteItem[]                  @relation("ItemPerformer")
  reactions               Reaction[]
  assignedServices        Service[]                    @relation("ServiceResponsible")
  staffProfile            StaffProfile?
  notificationPreferences UserNotificationPreference[]

  @@index([email])
  @@index([division])
  @@index([firstName])
  @@index([lastName])
  @@index([role], map: "idx_user_role_rls")
}

model Authenticator {
  id                   String  @id @default(uuid())
  credentialID         String  @unique
  credentialPublicKey  Bytes
  counter              BigInt
  credentialDeviceType String
  credentialBackedUp   Boolean
  transports           String?
  userId               String
  user                 User    @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model Customer {
  id                       String                 @id @default(uuid())
  userId                   String                 @unique
  name                     String
  phone                    String?
  address                  String?
  noShowCount              Int                    @default(0)
  isBlocked                Boolean                @default(false)
  requiresPrepayment       Boolean                @default(false)
  createdAt                DateTime               @default(now())
  updatedAt                DateTime               @updatedAt
  type                     String                 @default("AVULSO")
  recurringFrequency       String?
  discountPercentage       Float                  @default(0.0)
  internalNotes            String?
  balance                  Float                  @default(0.0)
  secondaryGuardianAddress String?
  secondaryGuardianEmail   String?
  secondaryGuardianName    String?
  secondaryGuardianPhone   String?
  additionalGuardians      Json?                  @default("[]")
  communicationOther       Json?
  communicationPrefs       Json?                  @default("[]")
  discoverySource          String?
  recurrenceDiscount       Float?
  recurrenceFrequency      String?
  deletedAt                DateTime?
  canRequestQuotes         Boolean                @default(true)
  riskLevel                String?                @default("Nivel 1")
  appointments             Appointment[]
  user                     User                   @relation(fields: [userId], references: [id])
  alerts                   CustomerAlert[]
  financialTransactions    FinancialTransaction[]
  invoices                 Invoice[]
  pets                     Pet[]
  quotes                   Quote[]

  @@index([userId])
  @@index([type])
  @@index([deletedAt])
  @@index([name])
  @@index([userId], map: "idx_customer_userid")
}

model FinancialTransaction {
  id               String   @id @default(uuid())
  customerId       String
  type             String
  amount           Float
  description      String
  category         String?
  relatedQuoteId   String?
  relatedInvoiceId String?
  createdBy        String
  createdAt        DateTime @default(now())
  notes            String?
  customer         Customer @relation(fields: [customerId], references: [id], onDelete: Cascade)
  relatedInvoice   Invoice? @relation(fields: [relatedInvoiceId], references: [id])
  relatedQuote     Quote?   @relation(fields: [relatedQuoteId], references: [id])

  @@index([customerId])
  @@index([type])
  @@index([createdAt])
  @@index([category])
}

model CustomerAlert {
  id         String    @id @default(uuid())
  customerId String
  type       String
  title      String
  message    String
  isActive   Boolean   @default(true)
  resolvedAt DateTime?
  resolvedBy String?
  createdBy  String
  createdAt  DateTime  @default(now())
  customer   Customer  @relation(fields: [customerId], references: [id], onDelete: Cascade)

  @@index([customerId])
  @@index([isActive])
  @@index([type])
}

model Pet {
  id               String        @id @default(uuid())
  customerId       String
  name             String
  species          String
  breed            String?
  weight           Float?
  observations     String?
  preferences      String?
  coatType         String?
  usesPerfume      Boolean       @default(false)
  usesOrnaments    Boolean       @default(false)
  marketingConsent Boolean       @default(false)
  temperament      String?
  firstTime        Boolean       @default(false)
  age              String?
  healthIssues     String?
  allergies        String?
  hasKnots         Boolean       @default(false)
  hasMattedFur     Boolean       @default(false)
  createdAt        DateTime      @default(now())
  updatedAt        DateTime      @updatedAt
  usedToGrooming   Boolean       @default(true)
  groomingAdapter  String?
  groomingHeight   String?
  groomingMachine  String?
  groomingNotes    String?
  groomingScissors String?
  appointments     Appointment[]
  customer         Customer      @relation(fields: [customerId], references: [id])
  quotes           Quote[]

  @@index([customerId])
  @@index([customerId], map: "idx_pet_customerid")
}

model Service {
  id                String             @id @default(uuid())
  name              String
  description       String?
  basePrice         Float
  duration          Int
  category          String?
  species           String             @default("Canino")
  createdAt         DateTime           @default(now())
  updatedAt         DateTime           @updatedAt
  maxWeight         Float?
  minWeight         Float?
  sizeLabel         String?
  responsibleId     String?
  seqId             Int                @unique @default(autoincrement())
  deletedAt         DateTime?
  subcategory       String?
  type              String?
  coatType          String?
  unit              String?            @default("por pet")
  quoteItems        QuoteItem[]
  responsible       User?              @relation("ServiceResponsible", fields: [responsibleId], references: [id])
  serviceExecutions ServiceExecution[]
  appointments      Appointment[]      @relation("AppointmentToService")

  @@index([deletedAt])
  @@index([responsibleId])
}

model Product {
  id          String    @id @default(uuid())
  seqId       Int       @unique @default(autoincrement())
  name        String
  description String?
  price       Float
  stock       Int       @default(0)
  category    String?   @default("Geral")
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  deletedAt   DateTime?

  @@index([deletedAt])
}

model Appointment {
  id                     String                  @id @default(uuid())
  customerId             String
  petId                  String
  startAt                DateTime
  status                 AppointmentStatus       @default(PENDENTE)
  cancellationReason     String?
  noShowReason           String?
  deletedAt              DateTime?
  createdAt              DateTime                @default(now())
  updatedAt              DateTime                @updatedAt
  notified24h            Boolean                 @default(false)
  notified1h             Boolean                 @default(false)
  category               AppointmentCategory     @default(SPA)
  seqId                  Int                     @unique @default(autoincrement())
  performerId            String?
  quoteId                String?
  customer               Customer                @relation(fields: [customerId], references: [id])
  performer              User?                   @relation("AppointmentPerformer", fields: [performerId], references: [id])
  pet                    Pet                     @relation(fields: [petId], references: [id])
  quote                  Quote?                  @relation(fields: [quoteId], references: [id])
  invoice                Invoice?
  serviceExecutions      ServiceExecution[]
  statusHistory          StatusHistory[]
  transport              TransportDetails?
  transportLegExecutions TransportLegExecution[]
  services               Service[]               @relation("AppointmentToService")

  @@index([customerId])
  @@index([status])
  @@index([startAt])
  @@index([deletedAt])
  @@index([performerId])
  @@index([category])
  @@index([category, deletedAt, startAt])
  @@index([customerId], map: "idx_appointment_customerid")
}

model TransportDetails {
  id              String          @id @default(uuid())
  appointmentId   String          @unique
  origin          String
  destination     String
  requestedPeriod TransportPeriod
  confirmedTime   DateTime?
  status          String          @default("SOLICITADO")
  type            String?
  appointment     Appointment     @relation(fields: [appointmentId], references: [id], onDelete: Cascade)
}

model Quote {
  id                     String                 @id @default(uuid())
  customerId             String
  petId                  String?
  status                 QuoteStatus            @default(SOLICITADO)
  totalAmount            Float                  @default(0)
  desiredAt              DateTime?
  createdAt              DateTime               @default(now())
  updatedAt              DateTime               @updatedAt
  deletedAt              DateTime?
  transportDestination   String?                @default("7Pet")
  transportOrigin        String?
  transportPeriod        TransportPeriod?
  type                   QuoteType              @default(SPA)
  hairLength             String?
  hasKnots               Boolean                @default(false)
  hasParasites           Boolean                @default(false)
  knotRegions            String?
  petQuantity            Int                    @default(1)
  transportReturnAddress String?
  seqId                  Int                    @unique @default(autoincrement())
  scheduledAt            DateTime?
  transportAt            DateTime?
  invoiceId              String?
  parasiteComments       String?
  parasiteTypes          String?
  wantsMedicatedBath     Boolean                @default(false)
  transportType          TransportType?
  transportLevaAt        DateTime?
  transportTrazAt        DateTime?
  appointments           Appointment[]
  financialTransactions  FinancialTransaction[]
  customer               Customer               @relation(fields: [customerId], references: [id])
  invoice                Invoice?               @relation(fields: [invoiceId], references: [id])
  pet                    Pet?                   @relation(fields: [petId], references: [id])
  items                  QuoteItem[]
  statusHistory          StatusHistory[]

  @@index([customerId])
  @@index([status])
  @@index([deletedAt])
  @@index([customerId], map: "idx_quote_customerid")
}

model QuoteItem {
  id          String   @id @default(uuid())
  quoteId     String
  description String
  quantity    Int      @default(1)
  price       Float    @default(0)
  serviceId   String?
  performerId String?
  discount    Float    @default(0)
  performer   User?    @relation("ItemPerformer", fields: [performerId], references: [id])
  quote       Quote    @relation(fields: [quoteId], references: [id], onDelete: Cascade)
  service     Service? @relation(fields: [serviceId], references: [id])

  @@index([quoteId])
  @@index([serviceId])
  @@index([quoteId], map: "idx_quoteitem_quoteid")
}

model Invoice {
  id                    String                 @id @default(uuid())
  customerId            String
  appointmentId         String?                @unique
  amount                Float
  status                InvoiceStatus          @default(PENDENTE)
  dueDate               DateTime
  createdAt             DateTime               @default(now())
  updatedAt             DateTime               @updatedAt
  deletedAt             DateTime?
  financialTransactions FinancialTransaction[]
  appointment           Appointment?           @relation(fields: [appointmentId], references: [id])
  customer              Customer               @relation(fields: [customerId], references: [id])
  payments              PaymentRecord[]
  quotes                Quote[]

  @@index([status])
  @@index([dueDate])
  @@index([deletedAt])
}

model PaymentRecord {
  id        String   @id @default(uuid())
  invoiceId String
  amount    Float
  paidAt    DateTime @default(now())
  method    String?
  createdAt DateTime @default(now())
  invoice   Invoice  @relation(fields: [invoiceId], references: [id])

  @@index([invoiceId])
  @@index([invoiceId], map: "idx_payment_invoiceid")
}

model StatusHistory {
  id            String       @id @default(uuid())
  appointmentId String?
  quoteId       String?
  oldStatus     String
  newStatus     String
  changedBy     String
  reason        String?
  createdAt     DateTime     @default(now())
  appointment   Appointment? @relation(fields: [appointmentId], references: [id])
  quote         Quote?       @relation(fields: [quoteId], references: [id])

  @@index([appointmentId])
  @@index([quoteId])
}

model Notification {
  id         String    @id @default(uuid())
  userId     String
  title      String
  message    String
  type       String
  read       Boolean   @default(false)
  createdAt  DateTime  @default(now())
  metadata   Json?
  priority   String?   @default("LOW")
  relatedId  String?
  resolved   Boolean   @default(false)
  resolvedAt DateTime?
  resolvedBy String?
  user       User      @relation(fields: [userId], references: [id])

  @@index([userId, read])
}

model AuditLog {
  id           String   @id @default(uuid())
  entityType   String
  entityId     String
  action       String
  performedBy  String
  previousData Json?
  newData      Json?
  createdAt    DateTime @default(now())
  reason       String?

  @@index([entityType, entityId])
}

model RolePermission {
  role        String   @id
  permissions String
  updatedAt   DateTime
  label       String?
}

model BugReport {
  id          String    @id @default(uuid())
  userId      String
  name        String
  description String
  imageUrl    String?
  status      String    @default("SOLICITADO")
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @default(now()) @updatedAt
  resolvedAt  DateTime?
  user        User      @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([userId], map: "idx_bugreport_userid")
}

model TransportSettings {
  id                  String   @id @default(uuid())
  handlingTimeLeva    Int      @default(0)
  handlingTimeTraz    Int      @default(0)
  updatedAt           DateTime @updatedAt
  kmPriceLargada      Float    @default(2.0)
  kmPriceLeva         Float    @default(2.0)
  kmPriceTraz         Float    @default(2.0)
  kmPriceRetorno      Float    @default(2.0)
  minPriceLargada     Float    @default(1.5)
  minPriceLeva        Float    @default(1.5)
  minPriceTraz        Float    @default(1.5)
  minPriceRetorno     Float    @default(1.5)
  handlingTimeLargada Int      @default(0)
  handlingTimeRetorno Int      @default(0)
}

model Metric {
  id        String   @id @default(uuid())
  type      String
  data      Json
  timestamp DateTime @default(now())

  @@index([type, timestamp])
  @@index([timestamp])
}

model PushSubscription {
  id        String   @id @default(uuid())
  userId    String
  endpoint  String   @unique
  p256dh    String
  auth      String
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model Post {
  id          String     @id @default(uuid())
  content     String
  authorId    String
  attachments Json?      @default("[]")
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt
  deletedAt   DateTime?
  comments    Comment[]
  author      User       @relation(fields: [authorId], references: [id])
  reactions   Reaction[]

  @@index([authorId])
  @@index([createdAt])
  @@index([deletedAt])
}

model Comment {
  id        String    @id @default(uuid())
  content   String
  authorId  String
  postId    String
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?
  author    User      @relation(fields: [authorId], references: [id])
  post      Post      @relation(fields: [postId], references: [id], onDelete: Cascade)

  @@index([postId])
  @@index([authorId])
}

model Reaction {
  id        String   @id @default(uuid())
  type      String
  authorId  String
  postId    String
  createdAt DateTime @default(now())
  author    User     @relation(fields: [authorId], references: [id])
  post      Post     @relation(fields: [postId], references: [id], onDelete: Cascade)

  @@unique([authorId, postId])
}

model Conversation {
  id            String        @id @default(uuid())
  type          String        @default("DIRECT")
  name          String?
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt
  lastMessageAt DateTime?
  messages      Message[]
  participants  Participant[]
}

model Participant {
  id             String       @id @default(uuid())
  userId         String
  conversationId String
  joinedAt       DateTime     @default(now())
  lastReadAt     DateTime?
  conversation   Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  user           User         @relation(fields: [userId], references: [id])

  @@unique([userId, conversationId])
  @@index([userId])
  @@index([conversationId])
}

model Message {
  id             String       @id @default(uuid())
  content        String
  senderId       String
  conversationId String
  createdAt      DateTime     @default(now())
  readBy         Json?        @default("[]")
  conversation   Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  sender         User         @relation("MessageSender", fields: [senderId], references: [id])

  @@index([conversationId])
  @@index([createdAt])
}

model NotificationSettings {
  id               String   @id @default(uuid())
  notificationType String   @unique
  enabled          Boolean  @default(true)
  frequency        String   @default("IMMEDIATE")
  allowedRoles     Json?    @default("[]")
  minInterval      Int      @default(0)
  updatedAt        DateTime @updatedAt
  updatedBy        String?

  @@index([notificationType])
}

model UserNotificationPreference {
  id               String   @id @default(uuid())
  userId           String
  notificationType String
  enabled          Boolean  @default(true)
  channels         Json?    @default("[\"IN_APP\", \"PUSH\"]")
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
  user             User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, notificationType])
  @@index([userId])
  @@index([notificationType])
}

model StaffProfile {
  id                       String                  @id @default(uuid())
  userId                   String                  @unique
  department               String
  payModel                 String
  dailyRate                Float?
  perLegRate               Float?
  payPeriodPreference      String                  @default("monthly")
  isActive                 Boolean                 @default(true)
  createdAt                DateTime                @default(now())
  updatedAt                DateTime                @updatedAt
  mealVoucher              Float?                  @default(0)
  otherBenefits            Float?                  @default(0)
  transportVoucher         Float?                  @default(0)
  bankAccount              String?
  bankAgency               String?
  bankName                 String?
  companyName              String?
  documentNumber           String?
  documentType             String?
  employmentType           String?                 @default("PF")
  notes                    String?
  pixKey                   String?
  address                  String?
  birthday                 DateTime?
  cnhCategory              String?
  cnhEar                   Boolean                 @default(false)
  cnhExpiry                DateTime?
  cnhNumber                String?
  emergencyContactName     String?
  emergencyContactPhone    String?
  emergencyContactRelation String?
  hiringDate               DateTime?
  attendanceRecords        AttendanceRecord[]
  payAdjustments           PayAdjustment[]
  payStatements            PayStatement[]
  serviceExecutions        ServiceExecution[]
  user                     User                    @relation(fields: [userId], references: [id], onDelete: Cascade)
  transportLegExecutions   TransportLegExecution[]

  @@index([department])
  @@index([isActive])
}

model AttendanceRecord {
  id           String       @id @default(uuid())
  staffId      String
  date         DateTime     @db.Date
  checkInAt    DateTime?
  checkOutAt   DateTime?
  status       String       @default("incomplete")
  notes        String?
  createdById  String
  updatedById  String?
  updateReason String?
  createdAt    DateTime     @default(now())
  updatedAt    DateTime     @updatedAt
  staff        StaffProfile @relation(fields: [staffId], references: [id], onDelete: Cascade)

  @@unique([staffId, date])
  @@index([staffId])
  @@index([date])
  @@index([status])
}

model ServiceExecution {
  id            String       @id @default(uuid())
  appointmentId String
  staffId       String
  serviceId     String?
  executedAt    DateTime     @default(now())
  notes         String?
  createdAt     DateTime     @default(now())
  appointment   Appointment  @relation(fields: [appointmentId], references: [id], onDelete: Cascade)
  service       Service?     @relation(fields: [serviceId], references: [id])
  staff         StaffProfile @relation(fields: [staffId], references: [id], onDelete: Cascade)

  @@index([appointmentId])
  @@index([staffId])
  @@index([executedAt])
}

model TransportLegExecution {
  id            String       @id @default(uuid())
  appointmentId String
  staffId       String
  legType       String
  completedAt   DateTime     @default(now())
  legValue      Float?
  notes         String?
  createdAt     DateTime     @default(now())
  appointment   Appointment  @relation(fields: [appointmentId], references: [id], onDelete: Cascade)
  staff         StaffProfile @relation(fields: [staffId], references: [id], onDelete: Cascade)

  @@unique([appointmentId, staffId, legType])
  @@index([appointmentId])
  @@index([staffId])
  @@index([completedAt])
}

model PayPeriod {
  id          String          @id @default(uuid())
  startDate   DateTime        @db.Date
  endDate     DateTime        @db.Date
  type        String
  status      String          @default("draft")
  createdById String
  closedById  String?
  closedAt    DateTime?
  createdAt   DateTime        @default(now())
  updatedAt   DateTime        @updatedAt
  adjustments PayAdjustment[]
  statements  PayStatement[]

  @@index([startDate, endDate])
  @@index([status])
}

model PayAdjustment {
  id          String       @id @default(uuid())
  payPeriodId String
  staffId     String
  type        String
  amount      Float
  direction   String
  reason      String
  createdById String
  createdAt   DateTime     @default(now())
  payPeriod   PayPeriod    @relation(fields: [payPeriodId], references: [id], onDelete: Cascade)
  staff       StaffProfile @relation(fields: [staffId], references: [id], onDelete: Cascade)

  @@index([payPeriodId])
  @@index([staffId])
}

model PayStatement {
  id               String       @id @default(uuid())
  payPeriodId      String
  staffId          String
  baseTotal        Float        @default(0)
  adjustmentsTotal Float        @default(0)
  totalDue         Float        @default(0)
  detailsJson      Json?
  generatedAt      DateTime     @default(now())
  payPeriod        PayPeriod    @relation(fields: [payPeriodId], references: [id], onDelete: Cascade)
  staff            StaffProfile @relation(fields: [staffId], references: [id], onDelete: Cascade)

  @@unique([payPeriodId, staffId])
  @@index([payPeriodId])
  @@index([staffId])
}

model HrAuditLog {
  id          String   @id @default(uuid())
  actorUserId String
  action      String
  entityType  String
  entityId    String
  metaJson    Json?
  createdAt   DateTime @default(now())

  @@index([actorUserId])
  @@index([entityType, entityId])
  @@index([createdAt])
}

enum AppointmentStatus {
  PENDENTE
  CONFIRMADO
  EM_ATENDIMENTO
  FINALIZADO
  CANCELADO
  NO_SHOW
}

enum QuoteStatus {
  SOLICITADO
  EM_PRODUCAO
  CALCULADO
  ENVIADO
  APROVADO
  REJEITADO
  AGENDAR
  ENCERRADO
  AGENDADO
  FATURAR
}

enum InvoiceStatus {
  PENDENTE
  PAGO
  VENCIDO
  MONITORAR
  NEGOCIADO
  ENCERRADO
  FATURAR
}

enum TransportPeriod {
  MANHA
  TARDE
  NOITE
}

enum QuoteType {
  SPA
  TRANSPORTE
  SPA_TRANSPORTE
}

enum TransportType {
  PICK_UP
  DROP_OFF
  ROUND_TRIP
}

enum AppointmentCategory {
  SPA
  LOGISTICA
}
