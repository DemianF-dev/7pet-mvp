<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üìä 7Pet - Monitoring Dashboard</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 16px;
            padding: 24px;
            margin-bottom: 24px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }

        .header h1 {
            font-size: 28px;
            color: #1a202c;
            margin-bottom: 8px;
        }

        .header .subtitle {
            color: #718096;
            font-size: 14px;
        }

        .health-badge {
            display: inline-block;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            margin-left: 12px;
        }

        .health-healthy {
            background: #10b981;
            color: white;
        }

        .health-degraded {
            background: #f59e0b;
            color: white;
        }

        .health-unhealthy {
            background: #ef4444;
            color: white;
        }

        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 24px;
        }

        .card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 16px;
            padding: 24px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .card:hover {
            transform: translateY(-4px);
            box-shadow: 0 12px 48px rgba(0, 0, 0, 0.15);
        }

        .card-title {
            font-size: 14px;
            font-weight: 600;
            color: #718096;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 12px;
        }

        .card-value {
            font-size: 36px;
            font-weight: 700;
            color: #1a202c;
            margin-bottom: 8px;
        }

        .card-label {
            font-size: 12px;
            color: #a0aec0;
        }

        .metric-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin-top: 16px;
        }

        .metric-item {
            padding: 12px;
            background: #f7fafc;
            border-radius: 8px;
        }

        .metric-item-label {
            font-size: 11px;
            color: #718096;
            margin-bottom: 4px;
        }

        .metric-item-value {
            font-size: 18px;
            font-weight: 600;
            color: #2d3748;
        }

        .chart-container {
            grid-column: 1 / -1;
            min-height: 300px;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 16px;
            padding: 24px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }

        #requestChart {
            width: 100%;
            height: 250px;
        }

        .endpoint-list {
            margin-top: 16px;
        }

        .endpoint-item {
            padding: 12px;
            background: #f7fafc;
            border-radius: 8px;
            margin-bottom: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .endpoint-path {
            font-family: 'Monaco', 'Courier New', monospace;
            font-size: 12px;
            color: #2d3748;
            font-weight: 500;
        }

        .endpoint-stats {
            font-size: 11px;
            color: #718096;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #718096;
        }

        .progress-bar {
            height: 6px;
            background: #e2e8f0;
            border-radius: 3px;
            margin-top: 8px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea, #764ba2);
            border-radius: 3px;
            transition: width 0.3s ease;
        }

        .status-indicator {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            margin-right: 8px;
        }

        .status-pass {
            background: #10b981;
        }

        .status-warn {
            background: #f59e0b;
        }

        .status-fail {
            background: #ef4444;
        }

        .refresh-info {
            color: #a0aec0;
            font-size: 11px;
            margin-top: 12px;
            text-align: center;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>
                üìä 7Pet Monitoring Dashboard
                <span id="healthBadge" class="health-badge">Loading...</span>
            </h1>
            <p class="subtitle">Real-time performance metrics and system health</p>
        </div>

        <div class="grid">
            <!-- Requests Card -->
            <div class="card">
                <div class="card-title">üì° Total Requests</div>
                <div class="card-value" id="totalRequests">-</div>
                <div class="card-label">
                    <span id="requestsPerMin">-</span> requests/min
                </div>
                <div class="metric-grid">
                    <div class="metric-item">
                        <div class="metric-item-label">Successful</div>
                        <div class="metric-item-value" style="color: #10b981;" id="successfulRequests">-</div>
                    </div>
                    <div class="metric-item">
                        <div class="metric-item-label">Failed</div>
                        <div class="metric-item-value" style="color: #ef4444;" id="failedRequests">-</div>
                    </div>
                </div>
            </div>

            <!-- Response Time Card -->
            <div class="card">
                <div class="card-title">‚ö° Avg Response Time</div>
                <div class="card-value" id="avgResponseTime">-</div>
                <div class="card-label">milliseconds</div>
                <div class="progress-bar">
                    <div class="progress-fill" id="responseTimeProgress"></div>
                </div>
            </div>

            <!-- Database Card -->
            <div class="card">
                <div class="card-title">üóÑÔ∏è Database</div>
                <div class="card-value" id="dbQueries">-</div>
                <div class="card-label">total queries</div>
                <div class="metric-grid">
                    <div class="metric-item">
                        <div class="metric-item-label">Avg Query Time</div>
                        <div class="metric-item-value" id="avgQueryTime">-</div>
                    </div>
                    <div class="metric-item">
                        <div class="metric-item-label">Slow Queries</div>
                        <div class="metric-item-value" style="color: #f59e0b;" id="slowQueries">-</div>
                    </div>
                </div>
            </div>

            <!-- Security Card -->
            <div class="card">
                <div class="card-title">üîí Security</div>
                <div class="card-value" id="authFailures">-</div>
                <div class="card-label">auth failures</div>
                <div class="metric-grid">
                    <div class="metric-item">
                        <div class="metric-item-label">CORS Blocked</div>
                        <div class="metric-item-value" id="blockedCORS">-</div>
                    </div>
                    <div class="metric-item">
                        <div class="metric-item-label">Rate Limited</div>
                        <div class="metric-item-value" id="rateLimited">-</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Chart -->
        <div class="chart-container">
            <div class="card-title">üìà Request Timeline (Last 5 Minutes)</div>
            <canvas id="requestChart"></canvas>
        </div>

        <!-- Health Checks -->
        <div class="card" style="margin-top: 24px;">
            <div class="card-title">üè• Health Checks</div>
            <div id="healthChecks" class="endpoint-list">
                <div class="loading">Loading health checks...</div>
            </div>
        </div>

        <!-- Top Endpoints -->
        <div class="card" style="margin-top: 24px;">
            <div class="card-title">üî• Top Endpoints</div>
            <div id="topEndpoints" class="endpoint-list">
                <div class="loading">Loading endpoints...</div>
            </div>
        </div>

        <div class="refresh-info">
            Auto-refresh every 5 seconds ‚Ä¢ Last updated: <span id="lastUpdate">-</span>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script>
        const API_BASE_URL = window.location.origin;
        let chart = null;

        // Initialize chart
        function initChart() {
            const ctx = document.getElementById('requestChart').getContext('2d');
            chart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Requests',
                        data: [],
                        borderColor: '#667eea',
                        backgroundColor: 'rgba(102, 126, 234, 0.1)',
                        tension: 0.4,
                        fill: true
                    }, {
                        label: 'Avg Duration (ms)',
                        data: [],
                        borderColor: '#764ba2',
                        backgroundColor: 'rgba(118, 75, 162, 0.1)',
                        tension: 0.4,
                        fill: true,
                        yAxisID: 'y1'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top'
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Requests'
                            }
                        },
                        y1: {
                            position: 'right',
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Duration (ms)'
                            },
                            grid: {
                                drawOnChartArea: false
                            }
                        }
                    }
                }
            });
        }

        // Fetch and update metrics
        async function updateMetrics() {
            try {
                // Fetch summary
                const summaryRes = await fetch(`${API_BASE_URL}/metrics/summary`);
                const summary = await summaryRes.json();

                // Update cards
                document.getElementById('totalRequests').textContent = summary.requests.total.toLocaleString();
                document.getElementById('requestsPerMin').textContent = summary.requests.requestsPerMinute;
                document.getElementById('successfulRequests').textContent = summary.requests.successful.toLocaleString();
                document.getElementById('failedRequests').textContent = summary.requests.failed.toLocaleString();
                document.getElementById('avgResponseTime').textContent = summary.requests.avgResponseTime + 'ms';
                document.getElementById('dbQueries').textContent = summary.database.queryCount.toLocaleString();
                document.getElementById('avgQueryTime').textContent = summary.database.avgQueryTime + 'ms';
                document.getElementById('slowQueries').textContent = summary.database.slowQueries;
                document.getElementById('authFailures').textContent = summary.security.authFailures;
                document.getElementById('blockedCORS').textContent = summary.security.blockedCORS;
                document.getElementById('rateLimited').textContent = summary.security.rateLimitHits;

                // Update progress bar
                const maxResponseTime = 500;
                const progress = Math.min((summary.requests.avgResponseTime / maxResponseTime) * 100, 100);
                document.getElementById('responseTimeProgress').style.width = progress + '%';

                // Update top endpoints
                updateTopEndpoints(summary.endpoints);

                // Fetch realtime data
                const realtimeRes = await fetch(`${API_BASE_URL}/metrics/realtime?minutes=5`);
                const realtime = await realtimeRes.json();
                updateChart(realtime.timeline);

                // Fetch health
                const healthRes = await fetch(`${API_BASE_URL}/metrics/health`);
                const health = await healthRes.json();
                updateHealth(health);

                // Update timestamp
                document.getElementById('lastUpdate').textContent = new Date().toLocaleTimeString();
            } catch (error) {
                console.error('Failed to fetch metrics:', error);
            }
        }

        function updateChart(timeline) {
            const labels = timeline.map(t => new Date(t.timestamp).toLocaleTimeString());
            const requests = timeline.map(t => t.requests);
            const durations = timeline.map(t => t.avgDuration);

            chart.data.labels = labels;
            chart.data.datasets[0].data = requests;
            chart.data.datasets[1].data = durations;
            chart.update();
        }

        function updateHealth(health) {
            const badge = document.getElementById('healthBadge');
            badge.textContent = health.status.toUpperCase();
            badge.className = `health-badge health-${health.status}`;

            const checksHtml = health.checks.map(check => `
                <div class="endpoint-item">
                    <div>
                        <span class="status-indicator status-${check.status}"></span>
                        <span class="endpoint-path">${check.name}</span>
                    </div>
                    <span class="endpoint-stats">${check.message || ''}</span>
                </div>
            `).join('');

            document.getElementById('healthChecks').innerHTML = checksHtml;
        }

        function updateTopEndpoints(endpoints) {
            const html = endpoints.slice(0, 5).map(ep => `
                <div class="endpoint-item">
                    <div>
                        <span class="endpoint-path">${ep.path}</span>
                    </div>
                    <span class="endpoint-stats">
                        ${ep.count} calls ‚Ä¢ ${Math.round(ep.avgDuration)}ms avg
                        ${ep.errors > 0 ? ` ‚Ä¢ <span style="color: #ef4444;">${ep.errors} errors</span>` : ''}
                    </span>
                </div>
            `).join('');

            document.getElementById('topEndpoints').innerHTML = html || '<div class="loading">No data yet</div>';
        }

        // Initialize and start auto-refresh
        initChart();
        updateMetrics();
        setInterval(updateMetrics, 5000); // Update every 5 seconds
    </script>
</body>
</html>
